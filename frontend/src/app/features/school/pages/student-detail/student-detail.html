<div class="app-page">
  <button mat-stroked-button color="primary" (click)="back()">Voltar para estudantes</button>

  <div class="page-header" *ngIf="student">
    <h2>{{ student.full_name }}</h2>
    <p>{{ student.school_name }} | {{ student.age_months }} meses</p>
  </div>

  <div class="action-row">
    <button mat-raised-button color="primary" (click)="openCreateVaccinationModal()" data-testid="vaccination-open-form">
      Novo registro vacinal
    </button>
  </div>

  <div class="grid-2" *ngIf="!loading">
    <mat-card class="card-surface">
      <div class="card-title">Situação vacinal</div>
      <div class="meta-line">
        <span>Status:</span>
        <span [class]="statusClass(status?.status)">{{ status?.status }}</span>
      </div>
      <div class="meta-line"><span>Calendário ativo:</span> <strong>{{ status?.activeScheduleCode || '-' }}</strong></div>

      <h4>Pendências</h4>
      <table mat-table [dataSource]="status?.pending || []">
        <ng-container matColumnDef="vacina">
          <th mat-header-cell *matHeaderCellDef>Vacina</th>
          <td mat-cell *matCellDef="let item">{{ item.vaccineName }}</td>
        </ng-container>
        <ng-container matColumnDef="dose">
          <th mat-header-cell *matHeaderCellDef>Dose</th>
          <td mat-cell *matCellDef="let item">{{ item.doseNumber }}</td>
        </ng-container>
        <ng-container matColumnDef="faixa">
          <th mat-header-cell *matHeaderCellDef>Faixa</th>
          <td mat-cell *matCellDef="let item">{{ item.recommendedMinAgeMonths }}-{{ item.recommendedMaxAgeMonths }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let item">
            <span [class]="statusClass(item.status)">{{ item.status }}</span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['vacina','dose','faixa','status']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['vacina','dose','faixa','status']"></tr>
      </table>
    </mat-card>
  </div>

  <mat-card class="table-card card-surface" *ngIf="!loading">
    <div class="card-title">Registros vacinais</div>

    <table mat-table [dataSource]="records">
      <ng-container matColumnDef="vaccine_name">
        <th mat-header-cell *matHeaderCellDef>Vacina</th>
        <td mat-cell *matCellDef="let row">{{ row.vaccine_name }}</td>
      </ng-container>

      <ng-container matColumnDef="dose_number">
        <th mat-header-cell *matHeaderCellDef>Dose</th>
        <td mat-cell *matCellDef="let row">{{ row.dose_number }}</td>
      </ng-container>

      <ng-container matColumnDef="application_date">
        <th mat-header-cell *matHeaderCellDef>Data</th>
        <td mat-cell *matCellDef="let row">{{ row.application_date }}</td>
      </ng-container>

      <ng-container matColumnDef="source">
        <th mat-header-cell *matHeaderCellDef>Fonte</th>
        <td mat-cell *matCellDef="let row">
          <span [class]="statusClass(row.source === 'CONFIRMADO_SAUDE' ? 'EM_DIA' : 'PENDENTE')">{{ sourceLabel(row.source) }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Ações</th>
        <td mat-cell *matCellDef="let row">
          <button mat-button (click)="editRecord(row)">Editar</button>
          <button mat-button color="warn" (click)="deleteRecord(row)">Remover</button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </mat-card>

  <div class="loading" *ngIf="loading"><mat-spinner diameter="30"></mat-spinner></div>
</div>

<ng-template #vaccinationFormDialog>
  <h2 mat-dialog-title>{{ vaccinationForm.value.id ? 'Editar registro vacinal' : 'Novo registro vacinal' }}</h2>
  <mat-dialog-content>
    <form [formGroup]="vaccinationForm" class="form-grid modal-form">
      <mat-form-field appearance="outline">
        <mat-label>Vacina</mat-label>
        <mat-select formControlName="vaccine">
          <mat-option *ngFor="let vaccine of vaccines" [value]="vaccine.id">{{ vaccine.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Dose</mat-label>
        <input matInput type="number" formControlName="dose_number" data-testid="vaccination-dose" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Data de aplicação</mat-label>
        <input matInput type="date" formControlName="application_date" data-testid="vaccination-date" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fonte</mat-label>
        <mat-select formControlName="source">
          <mat-option value="INFORMADO_ESCOLA">Informado pela escola</mat-option>
          <mat-option value="CONFIRMADO_SAUDE">Confirmado pela saúde</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Observações</mat-label>
        <input matInput formControlName="notes" />
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end" class="dialog-actions">
    <button mat-stroked-button type="button" (click)="closeVaccinationDialog()">Cancelar</button>
    <button mat-raised-button color="primary" type="button" (click)="saveVaccination()" data-testid="vaccination-save">
      Salvar
    </button>
  </mat-dialog-actions>
</ng-template>
